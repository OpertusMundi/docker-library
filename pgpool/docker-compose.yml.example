# vim: syntax=yaml

version: '3.8'

services:
  'pgpool':
    image: 'local/pgpool:${IMAGE_TAG:-4.1}'
    build:
      context: .
    volumes:
    - type: bind
      source: ./secrets/
      target: /secrets/
      read_only: true
    - type: bind
      source: ./certs/
      target: /certs/
      read_only: true
    environment:
      NUM_PROCS: 15
      TLS_KEY_FILE: /certs/server.key
      TLS_CERT_FILE: /certs/server.crt
      MONITOR_PASSWORD_FILE: /secrets/monitor-password
      # each file is considered a username; the contects are the password
      USER_PASSWORDS_DIR: /secrets/users/
      # define backend servers as a list of (host:port,weight,name)
      BACKEND: >-
        postgres-n1:5432,1,server1;postgres-n2:5432,1,server2
    networks:
      database_network: {}
    ports:
    - '30400:5433'

networks:
  database_network: {external: true}

